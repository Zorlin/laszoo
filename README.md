# Laszoo

*action follows intention*

Laszoo is a distributed configuration management tool that leverages MooseFS or CephFS for zero-config clustering and automatic synchronization of configuration files across hosts.

## Architecture

Laszoo depends on having a shared filesystem such as MooseFS or CephFS mounted on each managed node. This shared filesystem is used to store configuration templates and coordinate between nodes without requiring a central server.

### Directory Structure

```
/mnt/laszoo/                 # Shared filesystem mount
├── logs/                    # Logs generated by Laszoo
├── actions/                 # Actions taken against enrolled files
├── machines/                # Machine-specific files
│   └── <hostname>/          # Per-machine directory
│       └── manifest.json    # Enrolled files manifest
└── groups/                  # Group templates
    └── <groupname>/         # Per-group directory
        └── manifest.json    # Enrolled files manifest
        └── etc/mfs/         # Mirrors filesystem structure
            └── mfsmetalogger.cfg.lasz
```

Examples:

I want to create a set of configurations for my MooseFS metaloggers.

I create the file on one machine, then enroll it into the metaloggers group.

`laszoo enroll metaloggers /etc/mfs/mfsmetalogger.cfg`

If the file does not exist yet, Laszoo will create it based on the current machine's specified file or folder.

In other words, the MooseFS metalogger configuration from the local system will be copied to `/mnt/laszoo/groups/metaloggers/etc/mfs/mfsmetalogger.cfg.lasz`.

I then go to each additional machine I want to enroll, and run `laszoo enroll metaloggers` without a path to make that machine join the metaloggers group. The machine will automatically create each file within the `/mnt/laszoo/groups/metaloggers/` directory on its local system, including attributes like ownership and permissions.

Whenever I make a change to one of the servers, Laszoo will pick up on the change by comparing the watched file (`mfsmetalogger.cfg`) against the rendered version of the local file (`mfsmetalogger.cfg.lasz`).

Triggers allow you to run commands before and after applying changes.

Actions allow you to specify the behaviour of the systems when dealing with this enrollment.

For example:
```bash
laszoo enroll metaloggers /etc/mfs/mfsmetalogger.cfg --after="systemctl reload mfsmetalogger" --action=converge
```

Valid actions are:

* `converge` - Capture the changes made on the local system and apply it to the template.

This allows you to edit a file on one system and have the changes applied to all systems in the group. It applies changes both ways - changes made to one system affect all of them, and changes made to the templates affect all machines in the group.

* `rollback` - Rollback changes made to the local file to match what the rendered template looks like, allowing machines to be kept up to date with the latest changes.

* `freeze` - Freeze the changes made to the local file to match what the rendered template looks like, preventing further changes from being applied to the local file.

* `drift` - Ignore the changes made to the local file, allowing machines to drift, but track the difference between the local file and the rendered template (for the purposes of `laszoo status` and auditing).

Converge is the default, allowing for flexible management of many machines.

## Git integration

Laszoo can be integrated with Git to manage changes to the templates and files. This allows for version control and collaboration on changes to the templates and files, and a centralized timeline for all changes and commits.

Gitignore can be used to ignore certain files or directories when committing changes to the repository, to avoid committing sensitive information.

Laszoo can optionally use Ollama to generate sane git commit messages based on the changes it has picked up in each file or directory.

## Concepts
* Enrollment - `laszoo enroll moosefs /etc/mfs/mfsmaster.cfg`

You can enroll a file by running `laszoo enroll` followed by the group name and the path to the original file or folder.

This will create $mountpoint/groupname/etc/mfs/mfsmaster.cfg.lasz.

* Groups: `laszoo group moosefs add $machinename` + `laszoo group moosefs remove $machinename` + `laszoo group moosefs list` + `laszoo group moosefs rename $oldname $newname`

You can create a group simply by attempting to add a machine to a group that doesn't exist yet.

You can also do `laszoo groups list` for a list of all existing groups.

Removing the last member of a group will remove the group, unless you specify `--keep`.

Machines will keep track of which groups they're in by interacting with $mountpoint/machines/machine-name/etc/laszoo/groups.conf.

Groups will keep track of which machines they're in by creating symlinks for each server as `$mountpoint/memberships/group-name/machine-name/`.

* Enforcement - `laszoo apply moosefs`

Applies all files enrolled in the moosefs group to the local system.

Laszoo apply will take the templated version of the enrolled files and folders and apply them to the local system.

* Automation - `laszoo watch moosefs`

Laszoo watch will monitor enrolled files specified in the `moosefs` group and automatically apply the changes made to them to the local system.

Actions taken will depend on the options and actions specified during the `laszoo enroll` command.

* Compliance - `laszoo report moosefs`

Laszoo report will generate a report of every action taken against the enrolled files by Laszoo.

!note The level of logging of actions is configurable for privacy and compliance reasons, ranging from zero logging (no audit trail) to full logging (all actions logged, all details gathered).

* Difference - `laszoo diff moosefs`

Laszoo diff will show you the difference between the enrolled file and what it would look like if the template were to modify it (such as with `laszoo apply`).

* Package management - `laszoo install moosefs -p moosefs-master`

Laszoo install will install the specified package on all systems in the moosefs group - by modifying $mountpoint/groupname/etc/laszoo/packages.conf.

* Patch management - `laszoo patch moosefs`

Laszoo patch will instruct all machines in the moosefs group to apply package upgrades (such as `apt upgrade`) automatically.

Machines can be configured to apply patches in a rolling fashion, and can be configured to run a before and after command or script, using `--before` and `--after`.

This is achieved by creating a special package line in $mountpoint/groupname/etc/laszoo/packages.conf

* Update automation

Machines can be configured to watch their machine folder for commands to update packages and package sources. This is achieved by creating actions that can be triggered from either the machine or group folders - commanding one or all machine in a group to apply patches or other update actions.

Machines use a combination of last_seen_hash and last_seen_time to determine if they've seen an action line before, as well as a previous shadow copy of the configuration file that they keep for comparison.

To apply updates, simply add these metapackages to packages.conf:
```
++update
++upgrade
```

This will fetch the latest sources on each machine, then apply any needed updates.

It will be applied once to each machine, then the machine will update status.conf for itself and if needed, reboot.

You can apply "before" and "after" actions to the update and upgrade actions. These allow you specify that certain commands should be run before and afterwards, such as:

```
++update
++upgrade --before='curl $webhook_url -d "action=update&status=started&loadbalancer_state=drain"' --after 'curl $webhook_url -d "action=update&status=finished&loadbalancer_state=active"
```

You can also use syntax such as `++update && ++upgrade` to only proceed if the update step was successful.

Actions are applied in forward chronological order, ensuring that dependencies are met before proceeding.

Advanced coordination and rollout strategies are planned that would allow for targeting a small percentage of machines at a time, allowing for gradual rollouts and testing. This will be achieved by iterating through the list of machines in a group and setting their machine's packages.conf file to include the update and upgrade actions, with delays and staggered execution times.

* Action management - `laszoo act moosefs /etc/mfs/mfsmaster.cfg --before systemctl stop docker --after systemctl start docker`

This will create a persistent instruction to tell machines to run a command before and after applying changes to the enrolled file.

* Ignoring files - `laszoo ignore moosefs /etc/mfs/mfsmaster.cfg`

A special instruction, this will create a persistent instruction to tell machines to ignore changes to the enrolled file. It's only valid for files within a subfolder of an enrolled directory - or for an already-enrolled file (in which case it marks the file as enrolled as a machine specific file with action=drift).

## Package management

* Package management - `laszoo install moosefs -p moosefs-master`

Groups each have a $mountpoint/groupname/etc/laszoo/packages.conf that allows administrators to apply packages to systems in the group.

Machines also have a $mountpoint/machine/etc/laszoo/packages.conf that takes precedence over the group configuration (on an individual basis) - so if you have a package added in $group but removed in $machine, it will be removed from the machine.

packages.conf simply contains the following:

`^package-to-be-upgraded` - You can specify ^ to automatically upgrade a package on all systems in the group, optionally restarting or reloading a service after upgrade.

The syntax for specifying post-actions could be something like:
`^nginx --upgrade=systemctl restart nginx`

`+package-to-be-installed` - You can specify + to make sure a package is installed on all systems in the group.

This could be something like `+nano`.

`=package-to-be-kept` - If the package is already installed, keep it, but don't automatically install or remove it.

`!package-to-be-removed` - If the package is installed, remove it.

`!!!package-to-be-purged` - If the package is installed, purge it.

## Lasz syntax
Laszoo templates (.lasz files) are a literal identical copy of the original enrolled file, until they are edited.

The user can modify them as if they were just a normal file, or they may use {{ handlebar tags }} to dynamically generate content.

For machines that have unique content and configurations, you can use [[x quack tags x]] to create a string literal that will be applied only to the machine it's set on, leaving the other machines untouched. This will replace {{ quack }} in the .lasz group file with the contents of the quack tags in a matching position in the machine's .lasz file. Quack tags can span multiple lines and are useful for embedding machine-specific content within a template.

There is a machine version of each .lasz template, as well as a group version. The machine version takes precedence over the group version.

### Hybrid mode
Normally, when you have both a machine template and a group template, Laszoo will simply use the machine template.

However, you may want to use the group template but have specific sections overridden by the machine template.

To do this, place `{{ quack }}` in the group template where you want the machine template to override it. Then when enrolling the file, use --hybrid.

In the machine template, simply place your [[x quack x]] tags in the same order that the original {{ quack }} tags appeared in the group template.

Examples:

`/etc/hosts` (Group template)
```
192.168.1.1 {{ quack }}
{{ quack }}
```

with a machine template of
```
[[x ubuntu-server x]]
[[x 127.0.0.1	localhost
255.255.255.255	broadcasthost x]]
```

renders as:
```
192.168.1.1 ubuntu-server
127.0.0.1	localhost
255.255.255.255	broadcasthost
```

You can also specify only the first few quack tags in the machine template, allowing it to skip the remaining ones (leaving an empty string):
`/etc/hosts` (Machine template)
```
[[x ubuntu-server x]]
```

renders as
```
127.0.0.1 ubuntu-server
```
